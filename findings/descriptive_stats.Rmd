---
title: "descriptive statisitcs: figures and tables"
author: "Tino Schneidewind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data, echo=FALSE, warning=FALSE, message=FALSE}
## Preamble ####
rm(list=ls())

# packages
library(dplyr); library(tidyr); library(plotly);library(zoo); library(viridis); library(knitr)

data = read.csv("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/data/MedStat_aggregated/centroid_aggregated/hosp_buffer_8000.csv") # data

data$date = as.Date(data$date); data$station <- as.factor(data$station)

# index to include only stratum that have hosp counts
data$stratum_dow = as.factor(data$stratum_dow); data$stratum = as.factor(data$stratum)
ind_dow = tapply(data$all, data$stratum_dow, sum); ind = tapply(data$all, data$stratum, sum)

data <- data %>%
  mutate(y64 = a014y + a1564y) %>%
  mutate(o64 = a6574y + a7584y + a85plusy)

# create uninform timeseries of means
data_time_serie = data %>%
  group_by(date) %>%
  summarise(
    mean_f_id = mean(f_id, na.rm = TRUE),
    mean_temp = mean(temp, na.rm = TRUE),
    mean_all = mean(all, na.rm = TRUE))

# moving averages for time series
data_time_serie$MA_f_id = rollmean(data_time_serie$mean_f_id, k = 30, fill = NA, align = "center")
data_time_serie$MA_all = rollmean(data_time_serie$mean_all, k = 30, fill = NA, align = "center")
data_time_serie$MA_temp = rollmean(data_time_serie$mean_temp, k = 30, fill = NA, align = "center")

# start dates of station records
start_dates = data.frame(station = as.vector(unique(data$station)),
                         date = rep("no",8))

for (i  in 1:8) {
  subs = data[data$station == as.character(unique(data$station)[i]),]
  start_dates$date[i] <- as.character(min(subs$date))
  
}
start_dates$date <- as.Date(start_dates$date)

# daily means
data_daily_mean = data %>%
  mutate(daymonth = format(date, "%m-%d")) %>%
  group_by(daymonth) %>%
  summarise(
    across(c(mal, fem, y64, o64, cvd, resp), mean),
    mean_f_id = mean(f_id),
    mean_temp = mean(temp),
    mean_all = mean(all),
    p50_f_id = quantile(f_id, 0.5),
    p95_f_id = quantile(f_id, 0.95),
    p75_f_id = quantile(f_id, 0.8),
    p90_f_id = quantile(f_id, 0.9),
    p25_temp = quantile(temp, 0.25),
    p50_temp = quantile(temp, 0.5),
    p75_temp = quantile(temp, 0.75),
    p25_all = quantile(all, 0.25),
    p50_all = quantile(all, 0.5),
    p75_all = quantile(all, 0.75),
  ) %>%
  mutate(daymonth = as.Date(paste0("2000-", daymonth)))

# moving averages of daily data
data_daily_mean$MA50 = rollmean(data_daily_mean$p50_f_id, k = 30, fill = NA, align = "center")
data_daily_mean$MA95 = rollmean(data_daily_mean$p95_f_id, k = 30, fill = NA, align = "center")
data_daily_mean$MA75 = rollmean(data_daily_mean$p75_f_id, k = 30, fill = NA, align = "center")
data_daily_mean$MA90 = rollmean(data_daily_mean$p90_f_id, k = 30, fill = NA, align = "center")

data_daily_mean$MA25_temp = rollmean(data_daily_mean$p25_temp, k = 30, fill = NA, align = "center")
data_daily_mean$MA50_temp = rollmean(data_daily_mean$p50_temp, k = 30, fill = NA, align = "center")
data_daily_mean$MA75_temp = rollmean(data_daily_mean$p75_temp, k = 30, fill = NA, align = "center")

data_daily_mean$MA25_all = rollmean(data_daily_mean$p25_all, k = 30, fill = NA, align = "center")
data_daily_mean$MA50_all = rollmean(data_daily_mean$p50_all, k = 30, fill = NA, align = "center")
data_daily_mean$MA75_all = rollmean(data_daily_mean$p75_all, k = 30, fill = NA, align = "center")

# ticks annual cycle x axis
monthly_ticks <- data_daily_mean$daymonth[!duplicated(format(data_daily_mean$daymonth, "%Y-%m"))]

# colors
colors <- viridis(3, option = "viridis")

```

<br>

This Markdown document presents some descriptive statistics about the key variables: foehn, temperature and hospitalizations. The focus lies on the distribution, the annual cycle and for hospitalizations the percentages of the subgroups.The shown data is generated by using the 8km buffer around the measurement stations.

<br>

#### distribution and annual cycle


```{r plot_foehn, echo=FALSE, fig.width= 10, fig.height=12}

par(mfrow=c(3,2), 
    mar = c(4,4,.5,1))


hist(data$f_id[data$f_id!=0], 
     breaks = 40,
     col = colors[2], 
     xlim = c(0,300),
     xlab = "daily foehn score", 
     main = "", 
     # cex.axis = 0.6,
     ylab = "frequency")
text(285, 2250, labels = "(a)", pos = 2)

plot(data_daily_mean$daymonth, 
     data_daily_mean$mean_f_id, 
     xaxt = "n", col = colors[2],
     type = "p",
     xlab = "month", 
     ylab = "daily foehn score", 
     main = "",
     ylim = c(0,140), 
     pch = 16, 
     # cex.axis = 0.6, 
     # lwd = 2,
     bty = "n")

axis(1, 
     at = monthly_ticks + 15, 
     labels = substr(format(monthly_ticks, "%b"),1,1)#,cex.axis = 0.6
     )

lines(data_daily_mean$daymonth, data_daily_mean$MA50, col = 1, lwd = 2, lty = 1)
lines(data_daily_mean$daymonth, data_daily_mean$MA75, col = 1, lwd = 2, lty = 2)
lines(data_daily_mean$daymonth, data_daily_mean$MA90, col = 1, lwd = 2, lty = 3)
# lines(data_daily_mean$daymonth, data_daily_mean$MA95, col = 5, lwd = 2, lty = 1)

legend(monthly_ticks[6]+15, 120,
       legend = c("p50", "p75","p90"), bty = "n",
       col = c(1,1,1),lwd = 1, lty = c(1,2,3), #cex = 0.7, 
       ncol = 4)

text(monthly_ticks[12], 135, 
     labels = "(b)", pos = 2)

hist(data$temp, 
     breaks = 30,
     col = colors[1], 
     # xlim = c(0,300),
     xlab = "daily mean temperature [\u00B0C]", 
     main = "", 
     # cex.axis = 0.6,
     ylab = "frequency")
text(28, 3950, labels = "(c)", pos = 2)

plot(data_daily_mean$daymonth, 
     data_daily_mean$mean_temp, 
     xaxt = "n", col = colors[1],
     type = "p",
     xlab = "month", 
     ylab = "daily mean temperature [\u00B0C]", 
     main = "",
     ylim = c(-5,25),
     pch = 16, 
     # cex.axis = 0.6, 
     bty = "n")

axis(1, 
     at = monthly_ticks + 15, 
     labels = substr(format(monthly_ticks, "%b"),1,1)#, cex.axis = 0.6
     )

lines(data_daily_mean$daymonth, data_daily_mean$MA25_temp, col = 1, lwd = 2, lty = 3)
lines(data_daily_mean$daymonth, data_daily_mean$MA50_temp, col = 1, lwd = 2, lty = 1)
lines(data_daily_mean$daymonth, data_daily_mean$MA75_temp, col = 1, lwd = 2, lty = 2)

legend(monthly_ticks[4]+15, 3,  
       legend = c("p25", "p50","p75"), bty = "n",
       col = c(1,1,1),lwd = 1, lty = c(3,1,2),# cex = 0.7, 
       ncol = 3)

text(monthly_ticks[12], 23, labels = "(d)", pos = 2)


hist(data$all, 
     breaks = 50,
     col = colors[3], 
     xlim = c(0,20),
     xlab = "daily all-cause hospitalizations", 
     main = "", 
     # cex.axis = 0.6,
     ylab = "frequency")
text(19, 21000, labels = "(e)", pos = 2)

plot(data_daily_mean$daymonth, 
     data_daily_mean$mean_all, 
     xaxt = "n", col = colors[3],
     type = "p",
     xlab = "month", 
     ylab = "daily all-cause hospitalizations", 
     main = "",
     ylim = c(0,6),
     pch = 16, 
     # cex.axis = 0.6, 
     bty = "n")

axis(1, 
     at = monthly_ticks + 15, 
     labels = substr(format(monthly_ticks, "%b"),1,1)#, cex.axis = 0.6
     )

lines(data_daily_mean$daymonth, data_daily_mean$MA25_all, col = 1, lwd = 2, lty = 3)
lines(data_daily_mean$daymonth, data_daily_mean$MA50_all, col = 1, lwd = 2, lty = 1)
lines(data_daily_mean$daymonth, data_daily_mean$MA75_all, col = 1, lwd = 2, lty = 2)

legend(monthly_ticks[4]+15, 5.75,  
       legend = c("p25", "p50","p75"), bty = "n",
       col = c(1,1,1),lwd = 1, lty = c(3,1,2), #cex = 0.7, 
       ncol = 3)

text(monthly_ticks[12], 5.4, labels = "(f)", pos = 2)
```

*Figure 1: (a) daily foehn score distribution excluding 0-foehn days, (b) daily mean foehn score with 30-day moving averages of the 50th, 75th, 90th percentile, (c) daily mean temperature distribution, (d) daily averages of daily mean temperature with 30-day moving averages of the 25th, 50th, 75th percentile, (e) daily all-cause hospitalization distribution, (f) daily mean all-cause hospitalizations with 30-day moving averages of the 25th, 50th, 75th percentile.*

<br>

#### time series

```{r timeseriesplot, echo=FALSE, fig.width= 10, fig.height=9}

# margins
par(mfrow = c(3, 1), 
    mar = c(0, 4, 0, 0.5),  # Top two plots have zero bottom margin
    oma = c(4, 0, 0, 0))      # Outer bottom margin for x-axis label

# foehn plot
plot(data_time_serie$date, data_time_serie$MA_f_id,
     type = "n",
     xlab = "",
     ylab = "daily foehn score",
     xaxt = "n"
     )

for(i in start_dates$date){  abline(v = i, col = 1, lty = 2)}

abline(v = as.Date("2008-01-01"), col = "brown1", lty = 1)

lines(data_time_serie$date, data_time_serie$MA_f_id,     
      lty = 1,
     lwd = 2,
     col = colors[2],)

text(data_time_serie$date[nrow(data_time_serie)], 78, labels = "(a)", pos = 2)

# temp plot
plot(data_time_serie$date, data_time_serie$MA_temp,
     type = "n",
     xlab = "",
     ylab = "daily mean temperature [\u00B0C]",
     xaxt = "n"
     )

for(i in start_dates$date){  abline(v = i, col = 1, lty = 2)}

abline(v = as.Date("2008-01-01"), col = "brown1", lty = 1)

lines(data_time_serie$date, data_time_serie$MA_temp,
      lty = 1,
     lwd = 2,
     col = colors[1],)

text(data_time_serie$date[nrow(data_time_serie)], -2, labels = "(b)", pos = 2)

# hosp plot
plot(data_time_serie$date, data_time_serie$MA_all,
     type = "n",
     xlab = "",
     ylab = "daily all-cause hospitalizations",
     )

mtext("time", side = 1, line = 2, outer = TRUE, cex = 0.8)

for(i in start_dates$date){  abline(v = i, col = 1, lty = 2)}

abline(v = as.Date("2008-01-01"), col = "brown1", lty = 1)

lines(data_time_serie$date, data_time_serie$MA_all,      
     lty = 1,
     lwd = 2,
     col = colors[3])

text(data_time_serie$date[nrow(data_time_serie)], 1.8, labels = "(c)", pos = 2)

text(start_dates$date[1]+20, 4.8, labels = "(1)", pos = 2)
text(start_dates$date[4]-20, 4.8, labels = "(3)", pos = 4)
text(start_dates$date[5]+20, 4.8, labels = "(2)", pos = 2)
text(start_dates$date[7]-20, 4.8, labels = "(5)", pos = 4)
text(start_dates$date[8]+20, 4.8, labels = "(4)", pos = 2)
text(as.Date("2008-01-01")+10, 5.2, labels = "(x)", pos = 4, col = "brown1")
  
```

*Figure 2: (a) 30-day moving average time series of mean daily foehn, (b) 30-day moving average time series of average daily mean temperature, (c) 30-day moving average of mean daily hospitalization. (1) start of data from Altdorf, Chur, Davos, Montana, (2) start of data from Magadino, (3) start of data from Lugano, (4) start of data from Visp, (5) start of data from Poschiavo. (x) redefinition of the MedStat regions by the Swiss Federal Office for Statistics.*

<br>

#### hospitalization table

*Table 1: General information about the whole data set and hospitalization characteristics based on annual sums.*


```{r gen_table, echo=FALSE}
data$station_year = paste0(data$station, data$year)

gen_stats = data.frame(years = NA,
                       stations = NA,
                       start_date = "",
                       end_date = "2019-12-31",
                       n_NA = NA,
                       hosp_annual_mean = NA,
                       hosp_annual_sd = NA)

# general stats
gen_stats$years = length(unique(data$station_year))
gen_stats$stations = length(unique(data$station))
gen_stats$start_date = paste0(min(data$date), " ^")

# missing data
full_dates <- seq(min(data$date), max(data$date), by = "day")
missing_dates <- setdiff(full_dates, unique(data$date))

counter_mis = 0
counter_tot = 0

for(i in as.vector(unique(data$station_year))){
  subs = data[data$station_year == i,]
  
  full_dates = seq(min(subs$date), max(subs$date), by = "day")
  counter_tot = counter_tot + length(full_dates)
  counter_mis = counter_mis + ( length(full_dates) - nrow(subs) )
  
}

gen_stats$n_NA <- paste0( round( counter_mis / counter_tot, digits = 4) * 100, " %")

# hospitalizations
# yearly mean data all
subs_y_all = data %>%
  group_by(station_year) %>%
  summarize(summe = sum(all, na.rm = TRUE)) 

gen_stats$hosp_annual_mean = round(mean(subs_y_all$summe, na.rm = TRUE), digits = 2)
gen_stats$hosp_annual_sd = round(sd(subs_y_all$summe, na.rm = TRUE), digits = 2)
gen_stats$max_hosp = max(subs_y_all$summe, na.rm = TRUE)
gen_stats$min_hosp = min(subs_y_all$summe, na.rm = TRUE)


kable(gen_stats, 
      digits = 2, 
      col.names = c("years", "stations", "start date", "end date", "missing days", "mean hosp", "sd of hosp", "max hosp", "min hosp"),
      align = rep("r", ncol(gen_stats))
)

```

*^ for multiple stations the datasets started after this date (see appendix table 3 or figure 2)*


#### weather table

*Table 2: Temperature statistics in °C based on annual means and foehn statistics based on annual sums.*

```{r weather_stats, echo = FALSE}
weather_stats = data.frame(mean_temp = NA)

# yearly mean data all
subs_y_all = data %>%
  group_by(station_year) %>%
  summarize(mittel_temp = mean(temp, na.rm = TRUE),
            summe_foehn = sum(f_id, na.rm = TRUE)) 
  
# temperature stats
weather_stats$mean_temp = round(mean(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)
weather_stats$sd_temp = round(sd(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)
weather_stats$max_temp = round(max(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)
weather_stats$min_temp = round(min(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)

# foehn stats
weather_stats$mean_f =  round(mean(subs_y_all$summe_foehn, na.rm = TRUE), digits=2)
weather_stats$sd_f = round(sd(subs_y_all$summe_foehn, na.rm = TRUE), digits = 2)
weather_stats$max_f = max(subs_y_all$summe_foehn, na.rm = TRUE)
weather_stats$min_f = min(subs_y_all$summe_foehn, na.rm = TRUE)


kable(weather_stats, 
      digits = 2, 
      col.names = c("mean temp", "sd temp", "max temp", "min temp", "mean foehn", "sd foehn", "max foehn", "min foehn"),
      align = rep("r", ncol(weather_stats))
      
)



```


#### Appendix

*Table 3: General information per station and hospitalization characteristics per station based on annual sums.*

```{r gen_table_station, echo=FALSE}
stations = as.vector(unique(data$station)) 

gen_stats = data.frame(years = rep(NA,8),
                       row.names = stations)

for (i in 1:length(stations)) {
  sta = stations[i]
  
  subs = data[data$station == sta,]
  
  subs_y_all = subs %>%
  group_by(year) %>%
  summarize(summe = sum(all, na.rm = TRUE)) 

  gen_stats$years[i] = length(unique(subs$year))
  gen_stats$start_date[i] = min(as.character(subs$date))
  
  # missing data
  full_dates <- seq(min(subs$date), max(subs$date), by = "day")
  missing_dates <- setdiff(full_dates, subs$date)
  gen_stats$n_NA[i] <- paste0( round((length(missing_dates) / length(full_dates)), digits = 4) * 100, " %")
  
  # hosp stats
  gen_stats$perc_of_tot_hosp[i] = paste0(round( (sum(subs_y_all$summe) / sum(data$all) ), digits = 2)*100, " %")
  gen_stats$hosp_annual_mean[i] = mean(subs_y_all$summe, na.rm = TRUE)
  gen_stats$hosp_annual_sd[i] = sd(subs_y_all$summe, na.rm = TRUE)
  gen_stats$max_hosp[i] = max(subs_y_all$summe, na.rm = TRUE)
  gen_stats$min_hosp[i] = min(subs_y_all$summe, na.rm = TRUE) 
  
  
  
  
  }


kable(gen_stats, 
      digits = 2, 
      col.names = c("years", "start date", "missing days", "% of tot hosp" ,"mean hosp", "sd of hosp", "max hosp", "min hosp"      ),
      align = rep("r", ncol(gen_stats))
      
)

```



<br>

*Table 4: Temperature statistics in °C per station based on annual means and foehn statistics per station based on annual sums.*

```{r weather_stats_station, echo = FALSE}
weather_stats = data.frame(mean_temp = rep(NA, 8),
                           row.names = stations)


for (i in 1:length(stations)) {
  sta = stations[i]
  
  subs = data[data$station == sta,]
  
  subs_y_all = subs %>%
  group_by(year) %>%
  summarize(mittel_temp = mean(temp, na.rm = TRUE),
            summe_foehn = sum(f_id, na.rm = TRUE)) 
  
  # temperature stats
  weather_stats$mean_temp[i] = round(mean(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2 )
  weather_stats$sd_temp[i] =  round(sd(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)
  weather_stats$max_temp[i] = round(max(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)
  weather_stats$min_temp[i] = round(min(subs_y_all$mittel_temp, na.rm = TRUE), digits = 2)
  
  # foehn stats
  weather_stats$tot_foehn_per[i] = paste0(  round( (sum(data$f_id[data$station == sta]) / sum(data$f_id) ), digits = 2) *100, " %")
  weather_stats$mean_f[i] = mean(subs_y_all$summe_foehn, na.rm = TRUE)
  weather_stats$sd_f[i] = sd(subs_y_all$summe_foehn, na.rm = TRUE)
  weather_stats$max_f[i] = max(subs_y_all$summe_foehn, na.rm = TRUE)
  weather_stats$min_f[i] = min(subs_y_all$summe_foehn, na.rm = TRUE)
  
  }






kable(weather_stats, 
      digits = 2, 
      col.names = c("mean temp", "sd temp", "max temp", "min temp","% of tot foehn" ,"mean foehn", "sd foehn", "max foehn", "min foehn"),
      align = rep("r", ncol(weather_stats))
      # 
)



```


<br>
