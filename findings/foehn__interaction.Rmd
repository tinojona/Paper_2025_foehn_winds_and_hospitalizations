---
title: "the direct effect of foehn on hospitalizations"
author: "Tino Schneidewind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data, echo=FALSE, warning=FALSE, message=FALSE}
### PACKAGES ####
library(dlnm);library(splines);library(ggplot2);library(viridis);library(gnm); library(dplyr);library(knitr)

rm(list=ls())



### DATA ####

# buffer size for data file read
buffer = 8000

data = read.csv(paste0("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/data/MedStat_aggregated/centroid_aggregated/hosp_buffer_", buffer, ".csv"))

data$date = as.Date(data$date)
data$station <- as.factor(data$station)

# index to include only stratum that have hosp counts
data$stratum_dow = as.factor(data$stratum_dow); data$stratum = as.factor(data$stratum)
ind_dow = tapply(data$all, data$stratum_dow, sum); ind = tapply(data$all, data$stratum, sum)


# create larger age groups
data <- data %>%
  mutate(y64 = a014y + a1564y) %>%
  mutate(o64 = a6574y + a7584y + a85plusy)

# define the maximum lag distance we account for
maxlago <- 3

# mmt function
source("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/master_thesis/functions/findmin.R")

# crossbasis temp
cb.temp <- crossbasis(data$temp,
                      lag=21,
                      argvar=list(fun="ns", knots = quantile(data$temp, c(.5,.9), na.rm=TRUE)),
                      arglag=list(fun="ns", knots = logknots(21,3)),
                      group = data$station)

# binary foehn
foehn_bin <- ifelse(data$f_id > 72, 0, 1)
foehn_bin_rev <- ifelse(foehn_bin == 1, 0, 1)

# modifier functions
modif <- cb.temp * foehn_bin
modif_rev <- cb.temp * foehn_bin_rev

# groups
groups_id = colnames(data)[c(3,9,10,24,25, 13, 14, 11, 15, 12)]

letters = c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j")


# colors
colors <- viridis(3, option = "viridis")

foehn_col = colors[2]
temp_col = colors[3]
#####
```

<br>

This Markdown document presents and summarizes the findings of an analysis concerning the following research question.

<br>

#### *Results for RQ2+RQ3: is the temperature-hospitalizations association significantly modified by foehn in Switzerland? are certain subgroups more affected than others?*

<br>


```{r results_all, echo=FALSE, fig.width=3.3, fig.height=3.3, fig.align='center'}
par(mfrow=c(1,1), 
    mar = c(3,3,.5,.5),
    mgp = c(1.3, .5, 0))

foehn_col = "green4"
# temp_col = "purple"
temp_col = "gold2"

for (i in 1:length(groups_id[1])) {

  colvar  =  groups_id[i]

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)
  pred_modif2  <- crosspred(cb.temp, mod_modif_rev, cen = 20, cumul=FALSE)

  
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  min2 <- findmin(cb.temp,pred_modif2,from=quantile(data$temp, .1),to=quantile(data$temp, .9))

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, cumul=FALSE, by = .2)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, cumul=FALSE, by = .2)
  
  plot(pred_modif_new,              ## cumulative exposure
     "overall",
     ylab = "cumulative RR",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .15)),
     lwd = 2,
     main ="",
     ylim = c(0.7,3),
     cex.axis = 0.7,
     cex.lab = 0.7)

  
  lines(pred_modif_rev_new,           ## cumulative exposure
     "overall",
     col = temp_col,
     ci = "area",
     ci.arg = list(col = alpha(colour = temp_col, .15)),
     lwd = 2)
  
  text(25, 3 , labels = paste0("(", letters[i], ")"), pos = 2, cex = 0.7)}
# max(pred_modif_new$allRRhigh)
```


```{r results_subgroups, echo=FALSE, fig.width=9, fig.height=9, fig.align='center'}
par(mfrow=c(3,3), 
    mar = c(3,3,.5,.5),
    mgp = c(1.8, .5, 0))

for (i in 1:length(groups_id[2:10])) {

  colvar  =  groups_id[i]

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)
  pred_modif2  <- crosspred(cb.temp, mod_modif_rev, cen = 20, cumul=FALSE)

  
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  min2 <- findmin(cb.temp,pred_modif2,from=quantile(data$temp, .1),to=quantile(data$temp, .9))

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, cumul=FALSE, by = .2)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, cumul=FALSE, by = .2)
  
  plot(pred_modif_new,              ## cumulative exposure
     "overall",
     ylab = "cumulative RR",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .2)),
     lwd = 2,
     main ="",
     ylim = c(0.7,3)
     )

  
  lines(pred_modif_rev_new,           ## cumulative exposure
     "overall",
     col = temp_col,
     ci = "area",
     ci.arg = list(col = alpha(colour = temp_col, .2)),
     lwd = 2)
  
  text(25, 3, labels = paste0("(", letters[i+1], ")"), pos = 2)}
# max(pred_modif_new$allRRhigh)
```



*Figure 1: Cumulative response ratios for (a) all-cause, (b) male, (c), female, (d) 64 years and younger, (e) older than 64 years, (f) cvd, (g) resp, (h) inf, (i) uri, (j) ment hospitalization with a binary foehn threshold value of 72 which corresponds to 6 h of full foehn. The green line shows the temperature hospitallization association when foehn was present, the yellow line when foehn was abscent.*



<br>




