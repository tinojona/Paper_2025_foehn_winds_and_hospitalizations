---
title: "the direct effect of foehn on hospitalizations"
author: "Tino Schneidewind"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data, echo=FALSE, warning=FALSE, message=FALSE}
# ### PACKAGES ####
# library(dlnm);library(splines);library(ggplot2);library(viridis);library(gnm); library(dplyr);library(knitr);library(lmtest); library(grid);library(gridBase)
# library(ggstance)
# 
# rm(list=ls())
# 
# 
# 
# ### DATA ####
# 
# # buffer size for data file read
# buffer = 8000
# 
# data = read.csv(paste0("../../data/MedStat_aggregated/centroid_aggregated/hosp_buffer_", buffer, ".csv")) |>
#   mutate(station_date = paste0(station, date),
#          date = as.Date(date),
#          station = as.factor(station),
#          stratum_dow = as.factor(stratum_dow),
#          stratum = as.factor(stratum),
#          y64 = a014y + a1564y,
#          o64 = a6574y + a7584y + a85plusy,
#          foehn_bin = ifelse(f_id > 72, 0, 1), # binary foehn foehn_bin <- ifelse(data$f_id > 72, 0, 1);
#          foehn_bin_rev = ifelse(foehn_bin == 1, 0, 1)) # foehn_bin_rev <- ifelse(foehn_bin == 1, 0, 1)
# 
# # index to include only stratum that have hosp counts
# ind_dow = tapply(data$all, data$stratum_dow, sum); ind = tapply(data$all, data$stratum, sum)
# 
# # define the maximum lag distance we account for
# maxlago <- 3
# 
# # mmt function
# source("../functions/findmin.R")
# 
# # crossbasis temp
# cb.temp <- crossbasis(data$temp,
#                       lag=21,
#                       argvar=list(fun="ns", knots = quantile(data$temp, c(.5,.9), na.rm=TRUE)),
#                       arglag=list(fun="ns", knots = logknots(21,3)),
#                       group = data$station)
# 
# 
# 
# # modifier functions
# modif <- cb.temp * data$foehn_bin
# modif_rev <- cb.temp * data$foehn_bin_rev
# 
# # groups
# groups_id = c("all", "mal", "fem", "y64", "o64", "cvd", "resp", "inf", "uri", "ment" )
# letters = c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j")
# 
# 
# # colors
# colors <- viridis(3, option = "viridis")
# 
# foehn_col = colors[2]
# temp_col = colors[3]

#####
```

<br>

This Markdown document presents and summarizes the findings of an analysis concerning the following research question.

<br>

#### *Results for RQ2+RQ3: is the temperature-hospitalizations association significantly modified by foehn in Switzerland? are certain subgroups more affected than others?*

<br>

# Foehn and no foehn wind presence for ALL CAUSE HOSPITALIZATIONS

```{r results_all, echo=FALSE, fig.width=3.3, fig.height=3.3, fig.align='center'}
# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/plots/paper/rq3_all_plot.png", width = 900, height =1200, res = 300)

par(mfrow=c(1,1), 
    mar = c(3,3,.5,.5),
    mgp = c(1.8, .5, 0))

foehn_col = "green4"
temp_col = "gold2"

for (i in 1:length(groups_id)) {

  colvar  =  groups_id[i]
  print(colvar)

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20)
  
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp, pred_modif, 
                  from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  print(min1)

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, by = .1)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, by = .1)
  
  plot(pred_modif_new,              ## cumulative exposure
     "overall",
     ylab = "cumulative RR",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .15)),
     lwd = 2,
     main ="",
     ylim = c(0.7,2.5),
     cex.axis = 0.7,
     cex.lab = 0.7)


  lines(pred_modif_rev_new,           ## cumulative exposure
     "overall",
     col = temp_col,
     ci = "area",
     ci.arg = list(col = alpha(colour = temp_col, .15)),
     lwd = 2)

  abline(v =quantile(data$temp, .99), col = "black", lty = 2)

    legend("top", ncol = 1, legend = c("temp with interaction", "temp without interaction"), col = c("green4", "gold2"),
         bty = "n", lwd=c(2,2), cex = 0.7)

  text(25, 2.5 , labels = "(a)", pos = 4, cex = 0.7)
  }


# x="24.7"
# 
# 
# pred_modif_new$allRRfit[x]
# pred_modif_new$allRRlow[x]
# pred_modif_new$allRRhigh[x]
# 
# pred_modif_rev_new$allRRfit[x]
# pred_modif_rev_new$allRRlow[x]
# pred_modif_rev_new$allRRhigh[x]


# dev.off()
```

# Foehn and no foehn wind presence for SUBGROUPS HOSPITALIZATIONS

```{r results_subgroups, echo=FALSE, fig.width=9, fig.height=9, fig.align='center'}
# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/plots/paper/rq3_subgroups_plot.png", width = 1800, height =1800, res = 300)

# foehn_col = "green4"
# # temp_col = "purple"
# temp_col = "gold2"

par(mfrow=c(3,3), 
    mar = c(3,3,.5,.5),
    mgp = c(1.8, .5, 0))

# for (i in 1:length(groups_id[2:10])) {
for (i in 1:length(groups_id[2:10])) {

  colvar  =  groups_id[i+1]

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)

  
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, cumul=FALSE, by = .1)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, cumul=FALSE, by = .1)
  
  plot(pred_modif_new,              ## cumulative exposure
     "overall",
     ylab = "relative risk",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .2)),
     lwd = 2,
     main ="",
     ylim = c(0.7,3)
     )

  
  lines(pred_modif_rev_new,           ## cumulative exposure
     "overall",
     col = temp_col,
     ci = "area",
     ci.arg = list(col = alpha(colour = temp_col, .2)),
     lwd = 2)
  
  text(25, 3, labels = paste0("(", letters[i], ")"), pos = 2)}
# max(pred_modif_new$allRRhigh)

# dev.off()
```

<br>

# Table: Temperature on FOEHN AND NON FOEHN DAYS


```{r results_subgroups_table, echo=FALSE}
table_estimates = data.frame(all = rep(NA, 2),
                             mal = rep(NA, 2),
                             fem = rep(NA, 2),
                             y64 = rep(NA, 2),
                             o64  = rep(NA, 2),
                             cvd = rep(NA, 2),
                             resp = rep(NA, 2),
                             inf = rep(NA, 2),
                             uri = rep(NA, 2),
                             ment = rep(NA, 2),
                             row.names = c("RR temp + foehn [CI]", "RR temp - foehn [CI]"))


# print(quantile(data$temp, .99))

for (i in 1:length(groups_id[2:10])) {

  colvar  =  groups_id[10]
  
  

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)
  pred_modif2  <- crosspred(cb.temp, mod_modif_rev, cen = 20, cumul=FALSE)

  
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  min2 <- findmin(cb.temp,pred_modif2,from=quantile(data$temp, .1),to=quantile(data$temp, .9))

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, cumul=FALSE, by = .1)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, cumul=FALSE, by = .1)
 
  # extract prediction for value 24.7 and save it
  table_estimates[1,i] = paste0( sprintf("%.3f",round(pred_modif_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_new$allRRhigh["24.7"], digits = 3)), "]")
  
  table_estimates[2,i] = paste0( sprintf("%.3f",round(pred_modif_rev_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRhigh["24.7"], digits = 3)), "]")
  
  
   
}

table_estimates_transposed = t(table_estimates)

kable(table_estimates_transposed,
      # digits = 3,
      col.names = c("RR temp + foehn [CI]", "RR temp - foehn [CI]"),
      align = rep("r", ncol(table_estimates_transposed) )) 
```


# Figure: Temperature on FOEHN AND NON FOEHN DAYS


```{r results_subgroups_lollipop_figure, echo=FALSE}
table_estimates = data.frame(categories = c("all","all", "mal", "mal","fem","fem","y64","y64","o64","o64",
                                            "cvd","cvd","resp","resp","inf","inf","uri","uri","ment","ment"),
                             model = rep(c("temp + foehn", "temp - foehn"), 10),
                             pred = rep(NA, 20),
                             CI_low = rep(NA, 20),
                             CI_high = rep(NA, 20))

foehn_col = "green4"
# temp_col = "purple"
temp_col = "gold2"

for (i in 1:nrow(table_estimates)) {

  colvar  =  table_estimates$categories[i]
  
  if( i %% 2 != 0) {
    formula1 = as.formula(paste0(colvar, "~ cb.temp + modif"))
    
  } else {
    formula1 = as.formula(paste0(colvar, "~ cb.temp + modif_rev")) 
  }
    
  # GET UNIFORM MMT
  mod_modif     <-gnm(as.formula(paste0(colvar, "~ cb.temp + modif")), data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  print(min1)
  
  
  
  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # predict with new min values
  pred_modif_new  <- crosspred(cb.temp, mod_modif, cen = min1, cumul=FALSE, by = .1)
  
  
  table_estimates$pred[i]    = pred_modif_new$allRRfit["24.7"]
  table_estimates$CI_low[i]  = pred_modif_new$allRRlow["24.7"]
  table_estimates$CI_high[i] = pred_modif_new$allRRhigh["24.7"]


}
table_estimates$categories[7:8] = "y64"
table_estimates$categories[9:10] = "o64"


table_estimates$categories <- factor(table_estimates$categories, 
                                     levels = rev(unique(table_estimates$categories)))

table_estimates$model <- factor(table_estimates$model, 
                                levels = c("temp + foehn", "temp - foehn"))



# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/plots/paper/rq3_subgroups_lolli.png", 
    # width = 1200, height =1400, res = 300)
# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/plots/paper/rq3_subgroups_lolli_new.png",
    # width = 1000, height =1200, res = 300)

ggplot(table_estimates, aes(y = categories, x = pred, color = model)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  geom_pointrange(aes(xmin = CI_low, xmax = CI_high), 
                  position = position_dodgev(height = 0.4)) +
  labs(title = "",
       x = "cumulative RR", y = "") +
  theme_minimal() +
  scale_color_manual(
    values = c("temp + foehn" = foehn_col, "temp - foehn" = temp_col), 
    labels = c("temp + foehn" = "temp with interaction", "temp - foehn" = "temp without interaction"),  # Map the levels to custom labels
    name = "model:"  # Custom legend title
  ) +
  annotate("text", x = Inf, y = Inf, label = "(b)", 
           hjust = 1.2, vjust = 1.2, size = 3) +
  
  theme(
    legend.position = "none",
    # legend.position = c(1,1), # Position the legend at the top
    # legend.justification = c("right", "top"),
    # legend.title = element_text(size = 10),  # Font size for the legend title
    # legend.text = element_text(size = 8),    # Font size for the legend text
    axis.text.x = element_text(size = 8),    # Font size for x-axis labels
    axis.text.y = element_text(size = 8),    # Font size for y-axis labels
    axis.title.x = element_text(size = 10),  # Font size for x-axis title
    plot.margin = unit(c(0, 1, 0, 0), "cm"), # Adjust plot margins
    axis.line = element_line(color = "black"), # Add axis lines
    panel.grid.minor = element_blank(),       # Remove minor grid lines
    panel.grid.major.y = element_blank(),     # Remove horizontal grid lines
    panel.grid.major.x = element_blank(),  # Remove minor grid lines
    legend.margin = margin(.5, .5, .5, .5),
    legend.background = element_rect(fill = "white", color = "white"),
  ) +
  guides(color = guide_legend(ncol = 1))  # Set legend to one column

# dev.off()




```



# INTERACTION PLOT FOR ALL CAUSE 

```{r results_all_interaction, echo=FALSE, fig.width=3.3, fig.height=3.3, fig.align='center'}
png("../../Plots/revision/rq2_all_interaction_plot.png", width = 1000, height =1000, res = 300)
# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/Defence/rq2_interaction_all.png", width = 1800, height =1800, res = 300)
# par(
#   mar = c(3.5, 3.5, 1,1),
#   mgp = c(1.8, 0.7, 0))

par(mfrow=c(1,1),
    mar = c(3,3,.5,.5),
    mgp = c(1.8, .5, 0))

foehn_col = "green4"
# temp_col = "purple"
temp_col = "gold2"


for (i in 1:length(groups_id[3])) {

  colvar  =  groups_id[i]

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp")) # for baseline model to get p value

  # model with and without foehn
  mod_modif     <- gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(modif_rev, mod_modif, cen = 15.5, by = 0.1)
  
  # p value extraction
  # model_baseline     <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  
  
  # anova
  # anova_result <- anova(mod_modif, model_baseline, test = "LRT")

  plot(pred_modif,              ## cumulative exposure
     "overall",
     ylab = "relative risk",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .15)),
     # col = "grey2",
     # ci.arg = list(col = alpha(colour = "grey2", .15)),
     lwd = 2,
     main ="",
     ylim = c(0.7,2.5),
     # ylim = c(0.9,1.8),
     cex.axis = 0.7,
     cex.lab = 0.7
     )
  
  abline(v=24.7, lty = 2)
  
    est_CI <- paste0(
    round(pred_modif$allRRfit["24.7"], digits = 3),
    " (CI: ", 
    round(pred_modif$allRRlow["24.7"], digits = 3),
    "; " ,
    round(pred_modif$allRRhigh["24.7"], digits = 3),
    ")")
  
  text(25, 2, labels = est_CI, pos = 2)
  
  }

dev.off()
```


# SUBGROUPS INTERACTION PLOT


```{r results_subgroups_interaction, echo=FALSE, fig.width=9, fig.height=9, fig.align='center'}
png("../../Plots/revision/rq2_subgroups_interaction_plot.png", width = 1800, height =1800, res = 300)

par(mfrow=c(3,3), 
    mar = c(3,3,.5,.5),
    mgp = c(1.8, .5, 0))

for (i in 1:length(groups_id[1:9])) {

  colvar  =  groups_id[i+1]

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp"))
  
  
  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(modif_rev, mod_modif, cen = 15.5, by = 0.1)
                   
  plot(pred_modif,              ## cumulative exposure
     "overall",
     ylab = "relative risk",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .15)),
     lwd = 2,
     main ="",
     ylim = c(0.7,2.5),
     cex.axis = 0.7,
     cex.lab = 0.7)
  
  text(-14, 2.4, labels = paste0("(", letters[i], ")"), pos = 2)
  
  abline(v=24.7, lty = 2)
  
  est_CI <- paste0(
    round(pred_modif$allRRfit["24.7"], digits = 3),
    " (CI: ", 
    round(pred_modif$allRRlow["24.7"], digits = 3),
    "; " ,
    round(pred_modif$allRRhigh["24.7"], digits = 3),
    ")")
  
  text(25, 2, labels = est_CI, pos = 2)
  
  
  
  }

dev.off()
```



# INDIVIDUAL SUBGROUPS INTERACTION TERM 

```{r results_subgroups_interaction, fig.width=9, fig.height=9, fig.align='center', warning=FALSE, message=FALSE}
par(mfrow=c(3,3), 
    mar = c(3,3,.5,.5),
    mgp = c(1.8, .5, 0))
dev.off()

# binary foehn
foehn_bin <- ifelse(data$f_id > 72, 0, 1)
foehn_bin_rev <- ifelse(foehn_bin == 1, 0, 1)

# modifier functions
modif <- cb.temp * foehn_bin
modif_rev <- cb.temp * foehn_bin_rev

# for (i in 1:length(groups_id[1:10])) {
for (i in 1:length(groups_id[2])) {

  colvar  =  groups_id[i]

  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  # formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <- gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  # mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(modif, mod_modif, cen = 15.5, by =0.1)
  # pred_modif_rev <- crosspred(modif_rev, mod_modif_rev, cen = 15.5, by = 0.1)
  # pred_modif   <- crosspred(cb.temp, mod_modif, cen = 15.5, by =0.1)
  # pred_modif_rev <- crosspred(cb.temp, mod_modif_rev, cen = 15.5, by = 0.1)
  
  plot(pred_modif,              ## cumulative exposure
     "overall",
     ylab = "cumulative RR",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .2)),
     lwd = 2,
     main ="",
     # ylim = c(.99,1.02)
     )

  # print(colvar)
  print(pred_modif$allRRfit["24.7"])
  # print(pred_modif_rev$allRRfit["24.7"])
  # print(pred_modif$allRRlow["24.7"])
  # print(pred_modif$allRRhigh["24.7"])}
  
}



```




 
# Figure 3C
 
```{r multifigure, fig.height= 6, fig.width=6}
# png("../../Plots/revision/rq3_subgroups_lolli_new.png", width = 1650, height =1900, res = 300)

pdf("../../Plots/revision/figure_3_main_figure.pdf", width = 5.7, height =7)

# colors
foehn_col = "green4"
# temp_col = "purple"
temp_col = "gold2"
colors <- viridis(3, option = "viridis")


layout_matrix <- matrix(c(1, 1, 2, 2,  # First row: Plot 1 occupies left 40%, Plot 2 occupies right 60%
                          1, 1, 4, 4,  # Second row: Plot 1 occupies left 40%, Plot 3 (bottom-left) and Plot 4 (bottom-right)
                          3, 3, 4, 4,  # Third row: Plot 1 occupies left 40%, Plot 3 (bottom-left) and Plot 4 (bottom-right)
                          3, 3, 4, 4), # Fourth row: Plot 1 occupies left 40%, Plot 3 (bottom-left) and Plot 4 (bottom-right)
                        
                        nrow = 4, byrow = TRUE)

# Set up the layout with widths and heights
graphics::layout(mat = layout_matrix,
       # widths = c(0.6, 0.4),  # Left column 40%, right column 60%
       # heights = c(0.5, 0.5)
       )  # Both rows split equally (50% each)


# margins
# par(
#   mar = c(3, 3.5, 2,2),
#   mgp = c(1.8, 0.7, 0))


# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/Defence/rq2_temp_only.png", width = 1800, height =1800, res = 300)
# png("C:/Users/tinos/Desktop/test1.png", width = 1800, height = 1800, res = 300)
par(
  mar = c(3.5, 3.5, 1,1),
  mgp = c(2, 0.7, 0))

# PLOT 1 TOP LEFT : TEMPERATURE ONLY
cb.temp <- crossbasis(data$temp,
                      lag=21,
                      argvar=list(fun="ns", knots = quantile(data$temp, c(.5,.9), na.rm=TRUE)),
                      arglag=list(fun="ns", knots = logknots(21,3)),
                      group = data$station)
mod <- gnm(all ~ cb.temp, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
pred <- crosspred(cb.temp, mod, cumul=FALSE, cen = 0)
min1 <- findmin(cb.temp,pred,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
prednew <- crosspred(cb.temp, mod, cumul=FALSE, cen = min1)

plot(prednew,            
     "overall",
     col = colors[1],
     ci = "area",
     ci.arg = list(col = alpha(colour = colors[1], 0.25)), 
     xlab = "temperature [\u00B0C]",
     ylab = "relative risk",
     lwd = 2,
     main = "",
     # cex.axis = 1.5,
     # cex.lab = 1.5,
     cex.axis = 1,
     cex.lab = 1,
     ylim = c(0.8,2.3)
     )

 text(24, 2 , labels = "(a)", pos = 4, cex = 1)
 
 # legend("top", ncol = 1,
 #       legend = c("temperature \n(Model 3)"),
 #       col = c(colors[1]), bty = "n", lwd=c(3), cex = 1.5)

# dev.off()
# PLOT 2 : LEGEND
plot.new() 

par(
  mar = c(3.5, 6, 1,1),
  mgp = c(2, 0.7, 0))

legend("bottom", ncol = 1, 
       legend = c("temperature \n(Model 3)",
                  "temperature on foehn days  \n(Model 4)", 
                  "temperature on non-foehn days  \n(Model 4)"), 
       col = c(colors[1], "green4", "gold2"), bty = "n", lwd=c(3,3,3), cex = 1, ,y.intersp = 1.7)


# PLOT 3 BOTTOM LEFT : TEMPERATURE ON FOEHN AND NON-FOEHN DAYS
# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/Defence/rq2_temp_foehn_only.png", width = 1800, height =1800, res = 300)
# png("C:/Users/tinos/Desktop/test2.png", width = 1800, height = 1800, res = 300)
par(
  mar = c(3.5, 3.5, 1,1),
  mgp = c(2, 0.7, 0))

colvar  =  groups_id[1]

formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

# model with and without foehn
mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

# prediction with and without foehn
pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20)

min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))

pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, by = .1)
pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, by = .1)
  
plot(pred_modif_new,              ## cumulative exposure
     "overall",
     ylab = "relative risk",
     xlab = "temperature [\u00B0C]",
     col = "white",
     ci.arg = list(col = alpha(colour = "white", .15)),
     lwd = 2,
     main ="",
     ylim = c(0.8,2.3)
     # ,cex.axis = 1.5,
     # cex.lab = 1.5
     , cex.axis = 1,
     cex.lab = 1
     )

abline(v =quantile(data$temp, .99), col = "black", lty = 2)

lines(pred_modif_new,              ## cumulative exposure
     "overall",
     col = foehn_col,
     ci = "area",
     ci.arg = list(col = alpha(colour = foehn_col, .15)),
     lwd = 2)

  
lines(pred_modif_rev_new,           ## cumulative exposure
     "overall",
     col = temp_col,
     ci = "area",
     ci.arg = list(col = alpha(colour = temp_col, .15)),
     lwd = 2)

  
text(25, 2.15 , labels = "(b)", pos = 4, cex = 1)

# legend("top", ncol = 1,
#        legend = c("temperature on \nfoehn days (Model 4)", "temperature on \nnon-foehn days (Model 4)"),
#        col = c("green4", "gold2"), bty = "n", lwd=c(3,3), cex = 1.5, ,y.intersp = 1.7)

# dev.off()

# PLOT 4 BOTTOM RIGHT : Lollipop FIGURE
# png("C:/Users/tinos/Desktop/test3.png", width = 2000, height = 2500, res = 300)
# pdf("C:/Users/tinos/Documents/Master - Climate Science/4 - Praktikum/Climate Epidemiology and Public Health/Swiss Global Change Day - Poster/rq1_foehn_only_biglab.pdf", 
    # width = 2100, height =2100
    # width = 8.5, height =10.5
    # , res = 300
    # )
# png("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/Defense/rq2_temp_foehn_subgroups.png", width = 2000, height =2500, res = 300)
par(
mar = c(3.5, 4.5, 1,1),
mgp = c(2.1, 0.7, 0))


table_estimates$categories = c("all", "all", "male", "male", "female", "female","<65 years", "<65 years", ">64 years", ">64 years", "circulatory", "circulatory", "respiratory", "respiratory", "infectious", "infectious", "genitourinary", "genitourinary" ,"mental", "mental" )

table_estimates$categories <- factor(
  table_estimates$categories,
  levels = rev(unique(table_estimates$categories)) # Use the order they appear in the data
)


# Sample data setup (replace this with your actual 'table_estimates' data)
categories <- table_estimates$categories
pred <- table_estimates$pred  # Random example values for relative risk
CI_low <- table_estimates$CI_low  # Lower bound for CI
CI_high <- table_estimates$CI_high  # Upper bound for CI
model <- table_estimates$model  # Random example model labels
foehn_col <- "green4"
# foehn_col <- "red3"
temp_col <- "gold2"

plot(1, type = "n", xlim = c(0.5, 2.5), ylim = c(0.5, length(categories) + 0.5), 
     xlab = "relative risk", ylab = "", main = "", yaxt = "n", xaxt="n", bty = "n"
     ,cex.axis = 1, 
     ,cex.lab = 1
     )
abline(v = 1, lty = 2, col = "black")

# Define vertical offsets for different models (to bring points closer within a category)
offset <- - 0.25  # Adjust this value for how close the lines should be
vertical_shift <- 0.3  # The overall downward shift for all lines

# Add error bars (pointrange)
for(i in 1:length(pred)) {
  col <- ifelse(model[i] == "temp + foehn", foehn_col, temp_col)
  
  # Adjust the vertical position by combining the shift and offset
  vertical_position <- length(categories) - i + 1 - vertical_shift  # Apply the vertical shift
  
  if (model[i] == "temp + foehn") {
    vertical_position <- vertical_position + offset  # Apply model-specific offset
  } else {
    vertical_position <- vertical_position - offset  # Apply model-specific offset
  }

  # Draw the error bars
  segments(CI_low[i], vertical_position, CI_high[i], vertical_position, col = col, lwd = 2)
  # Draw the points
  points(pred[i], vertical_position, pch = 16, col = col, cex = 1)
}


# Add annotation text "(c)" at the top right
text(2.2, length(categories) - 2, labels = "(c)", pos = 4, cex = 1.1)

# Add continuous y-axis with ticks every second label
axis(2, at = seq(1, length(categories), by = 2), labels = rev(categories)[seq(1, length(categories), by = 2)], las = 1
     # ,cex.axis = 0.8
     ,cex.axis = 1
     )
axis(1, at = seq(0.5,2.5,0.5)
     # , cex.axis = 0.8
     ,cex.axis = 1
     )

rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[3], border = "black", lwd = 1)  # Bottom border
rect(par("usr")[1], par("usr")[3], par("usr")[1], par("usr")[4], border = "black", lwd = 2)  # Left border


# legend("topright", ncol = 1,
#        legend = c("temperature on \nfoehn days", "temperature on \nnon-foehn days"),
#        col = c("red3", "gold2"), bty = "n", lwd=c(6,6), cex = 2, ,y.intersp = 1.9)

dev.off()



```


3D PLOT OF TEMPERATURE


```{r}

cb.temp <- crossbasis(data$temp,
                      lag=21,
                      argvar=list(fun="ns", knots = quantile(data$temp, c(.5,.9), na.rm=TRUE)),
                      arglag=list(fun="ns", knots = logknots(21,3)),
                      group = data$station)
mod <- gnm(all ~ cb.temp, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
prednew <- crosspred(cb.temp, mod, cumul=FALSE, cen = 20, by = .1)

# png("C:/Users/tinos/Desktop/test5.png", width = 1800, height = 1800, res = 300)
# par(
#   mar = c(2, 3, 1,2),
#   mgp = c(2.8, 2.5, 0))

plot(prednew,            
     "3d",
     
     main = "",
     xlab = "Temperature [°C]",
     zlab = "relative risk",
     
     zlim = c(0.95,1.1),
     col = colors[1],
     border = "white",
     # shade = 0.1,
     lwd = .2,
     # nlevels = 15,not a graphical parameter!
     ticktype = "detailed",
     
     expand = .8,
     theta = 60, # rotation
     phi = 25 # elevation
    
     )


# dev.off()

x="24.7"

prednew$allRRfit[x]
prednew$allRRlow[x]
prednew$allRRhigh[x]
```




# INVESTIGATION INTO OLD FEMALES CAUSING OLD AND FEMALES TREND (NO THEY DONT)

```{r}

data_oldfems = read.csv(paste0("C:/Users/tinos/Documents/Master - Climate Science/3 - Master Thesis/data/MedStat_aggregated/centroid_aggregated/hosp_buffer_", buffer, "_oldfems.csv")) |>
  mutate(station_date = paste0(station, date))


data_oldfems_merged <- data %>%
      left_join(data_oldfems, by = "station_date")

data_oldfems_merged <- data_oldfems_merged |>
  mutate(
    fem_o64 = rowSums(across(c(fem_a6574y, fem_a7584y, fem_a85plusy))),
    fem_y64 = rowSums(across(c(fem_a014y, fem_a1564y))),
    fem_o75 = rowSums(across(c(fem_a7584y, fem_a85plusy)))
  )
  

formula1  <- as.formula("fem_a85plusy ~ cb.temp + modif_rev")

# model with and without foehn
mod_modif     <-gnm(formula1, data = data_oldfems_merged,  family=quasipoisson(), eliminate=stratum_dow.x, subset=ind_dow>0)

# prediction with and without foehn
pred_modif   <- crosspred(modif_rev, mod_modif, cen = 15.5, by = 0.1)
  

plot(pred_modif,              ## cumulative exposure
     "overall",
     ylab = "relative risk",
     xlab = "temperature [\u00B0C]",
     col = foehn_col,
     ci.arg = list(col = alpha(colour = foehn_col, .15)),
     lwd = 2,
     main ="",
     ylim = c(0.7,2.5),
     cex.axis = 0.7,
     cex.lab = 0.7)
```



# REVIEW: sensitivity analysis of results of temperature foehn winds interaction including all data and only post 2008 data.
# CAREFUL: two definition for data, cb, etc

```{r review}

table_estimates_review = data.frame(all = rep(NA, 4),
                             mal = rep(NA, 4),
                             fem = rep(NA, 4),
                             y64 = rep(NA, 4),
                             o64  = rep(NA, 4),
                             cvd = rep(NA, 4),
                             resp = rep(NA, 4),
                             inf = rep(NA, 4),
                             uri = rep(NA, 4),
                             ment = rep(NA, 4),
                             row.names = c("all: temp + foehn", "all: temp - foehn", "2008-: temp + foehn", "2008-: temp - foehn"))

# save MMT
MMT_subgroups = rep(NA, ncol(table_estimates_review))

# the first loop for all data
for (i in 1:length(groups_id)) {

  colvar  =  groups_id[i]
  
  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp + modif_rev"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  mod_modif_rev <- gnm(formula2, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)

  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)
  
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  
  # save MMT
  MMT_subgroups[i] <- min1

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = min1, cumul=FALSE, by = .1)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = min1, cumul=FALSE, by = .1)
 
  # extract prediction for value 24.7 and save it
  table_estimates_review[1,i] = paste0( sprintf("%.3f",round(pred_modif_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_new$allRRhigh["24.7"], digits = 3)), "]")
  
  table_estimates_review[2,i] = paste0( sprintf("%.3f",round(pred_modif_rev_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRhigh["24.7"], digits = 3)), "]")
   
}


data_2008 <- data |> filter(data$date >= "2008-01-01")

# index to include only stratum that have hosp counts
ind_dow_2008 = tapply(data_2008$all, data_2008$stratum_dow, sum); ind_2008 = tapply(data_2008$all, data_2008$stratum, sum)

# crossbasis temp
cb.temp_2008 <- crossbasis(data_2008$temp,
                      lag=21,
                      argvar=list(fun="ns", knots = quantile(data_2008$temp, c(.5,.9), na.rm=TRUE)),
                      arglag=list(fun="ns", knots = logknots(21,3)),
                      group = data_2008$station)



# modifier functions
modif_2008 <- cb.temp_2008 * data_2008$foehn_bin
modif_rev_2008 <- cb.temp_2008 * data_2008$foehn_bin_rev




# the second loop for post 2008 data
for (i in 1:length(groups_id)) {

  colvar  =  groups_id[i]
  
  formula1  <- as.formula(paste0(colvar, "~ cb.temp_2008 + modif_2008"))
  formula2 <- as.formula(paste0(colvar, "~ cb.temp_2008 + modif_rev_2008"))

  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data_2008,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow_2008>0)
  mod_modif_rev <- gnm(formula2, data = data_2008,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow_2008>0)

  # predict with new min values
  pred_modif_new     <- crosspred(cb.temp, mod_modif, cen = MMT_subgroups[i], cumul=FALSE, by = .1)
  pred_modif_rev_new <- crosspred(cb.temp, mod_modif_rev, cen = MMT_subgroups[i], cumul=FALSE, by = .1)
 
  # extract prediction for value 24.7 and save it
  table_estimates_review[3,i] = paste0( sprintf("%.3f",round(pred_modif_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_new$allRRhigh["24.7"], digits = 3)), "]")
  
  table_estimates_review[4,i] = paste0( sprintf("%.3f",round(pred_modif_rev_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRhigh["24.7"], digits = 3)), "]")
   
}








table_estimates_transposed_review = t(table_estimates_review)

kable(table_estimates_transposed,
      # digits = 3,
      col.names = c("all: temp + foehn", "all: temp - foehn", "2008-: temp + foehn", "2008-: temp - foehn"),
      align = rep("r", ncol(table_estimates_transposed) )) 
```



# REVIEW: DIFFERENT FOEHN WIND AGGREGATION

```{r FOEHN FULL}

# buffer size for data file read
data_ff = read.csv("../../data/MedStat_aggregated/centroid_aggregated/hosp_buffer_8000sensitivity_onlyfullfoehnaggregation.csv") |>
  mutate(station_date = paste0(station, date),
         date = as.Date(date),
         station = as.factor(station),
         stratum_dow = as.factor(stratum_dow),
         stratum = as.factor(stratum),
         y64 = a014y + a1564y,
         o64 = a6574y + a7584y + a85plusy,
         foehn_bin = ifelse(f_id_sens > 72, 0, 1), # binary foehn foehn_bin <- ifelse(data$f_id > 72, 0, 1);
         foehn_bin_rev = ifelse(foehn_bin == 1, 0, 1)) # foehn_bin_rev <- ifelse(foehn_bin == 1, 0, 1)

# index to include only stratum that have hosp counts
ind_dow_ff = tapply(data$all, data$stratum_dow, sum); ind_ff = tapply(data$all, data$stratum, sum)

# crossbasis temp
cb.temp_ff <- crossbasis(data_ff$temp,
                      lag=21,
                      argvar=list(fun="ns", knots = quantile(data_ff$temp, c(.5,.9), na.rm=TRUE)),
                      arglag=list(fun="ns", knots = logknots(21,3)),
                      group = data_ff$station)



# modifier functions
modif_ff <- cb.temp_ff * data_ff$foehn_bin
modif_rev_ff <- cb.temp_ff * data_ff$foehn_bin_rev



table_estimates_review2 = data.frame(all = rep(NA, 2),
                             mal = rep(NA, 2),
                             fem = rep(NA, 2),
                             y64 = rep(NA, 2),
                             o64  = rep(NA, 2),
                             cvd = rep(NA, 2),
                             resp = rep(NA, 2),
                             inf = rep(NA, 2),
                             uri = rep(NA, 2),
                             ment = rep(NA, 2),
                             row.names = c("full: temp + foehn", "full: temp - foehn"))


# loop through the subpops while using the MMT from the OG data
for (i in 1:length(groups_id)) {

  colvar  =  groups_id[i]
  
  
  # determine MMT
  formula1  <- as.formula(paste0(colvar, "~ cb.temp + modif"))
  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow>0)
  # prediction with and without foehn
  pred_modif   <- crosspred(cb.temp, mod_modif, cen = 20, cumul=FALSE)
  # get min value of both predictions and use for centering
  min1 <- findmin(cb.temp,pred_modif,from=quantile(data$temp, .1),to=quantile(data$temp, .9))
  

  
  # model the rr in the full foehn aggregated sets
  formula1  <- as.formula(paste0(colvar, "~ cb.temp_ff + modif_ff"))
  formula2  <- as.formula(paste0(colvar, "~ cb.temp_ff + modif_rev_ff"))
  
  # model with and without foehn
  mod_modif     <-gnm(formula1, data = data_ff,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow_ff>0)
  mod_modif_rev     <-gnm(formula2, data = data_ff,  family=quasipoisson(), eliminate=stratum_dow, subset=ind_dow_ff>0)
  
  # prediction with and without foehn
  pred_modif_new   <- crosspred(cb.temp_ff, mod_modif, cen = min1, cumul=FALSE, by = 0.1)
  pred_modif_rev_new   <- crosspred(cb.temp_ff, mod_modif_rev, cen = min1, cumul=FALSE, by = 0.1)
  
  print(paste0(colvar, " ", min1))
  
  plot(pred_modif_new, "overall")
  
  
 
  # extract prediction for value 24.7 and save it
  table_estimates_review2[1,i] = paste0( sprintf("%.3f",round(pred_modif_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_new$allRRhigh["24.7"], digits = 3)), "]")
  
  table_estimates_review2[2,i] = paste0( sprintf("%.3f",round(pred_modif_rev_new$allRRfit["24.7"],digits=3)), 
                                         " [", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRlow["24.7"], digits=3)),
                                         "-", 
                                         sprintf("%.3f",round(pred_modif_rev_new$allRRhigh["24.7"], digits = 3)), "]")
   
}


table_estimates_transposed_review = t(table_estimates_review2)

kable(table_estimates_transposed_review,
      # digits = 3,
      col.names = c("full: temp + foehn", "full: temp - foehn"),
      align = rep("r", ncol(table_estimates_transposed_review) )) 

write.csv(table_estimates_transposed_review, "fullfoehnresults.csv")
```









